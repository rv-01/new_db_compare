graph TB
    %% Start and Configuration
    Start([ğŸš€ DB-Sentinel Start]) --> LoadConfig[ğŸ“„ Load config.yaml]
    LoadConfig --> ValidateConfig{âœ… Validate Configuration}
    ValidateConfig -->|âŒ Invalid| ConfigError[âŒ Configuration Error<br/>Exit with Error]
    ValidateConfig -->|âœ… Valid| ParseTables[ğŸ“‹ Parse Table Configurations]
    
    %% Database Connections
    ParseTables --> InitDB[ğŸ”Œ Initialize Database Managers]
    InitDB --> ConnSource[ğŸ—„ï¸ Connect to Source DB<br/>Connection Pool]
    InitDB --> ConnTarget[ğŸ—„ï¸ Connect to Target DB<br/>Connection Pool]
    
    %% Table Validation
    ConnSource --> ValidateTables{ğŸ” Validate All Tables}
    ConnTarget --> ValidateTables
    ValidateTables -->|âŒ Invalid| TableError[âŒ Table Validation Error<br/>Missing tables/columns]
    ValidateTables -->|âœ… Valid| CheckRestart{ğŸ”„ Check Restart Mode}
    
    %% Restart Logic
    CheckRestart -->|Restart Enabled| LoadCheckpoint[ğŸ“Š Load Checkpoint Data<br/>from Metadata Table]
    CheckRestart -->|Fresh Start| ClearCheckpoint[ğŸ§¹ Clear Old Checkpoints]
    LoadCheckpoint --> FilterTables[ğŸ”„ Filter Completed Tables]
    ClearCheckpoint --> ProcessAllTables[ğŸ“‹ Process All Tables]
    FilterTables --> ProcessRemaining[ğŸ“‹ Process Remaining Tables]
    
    %% Multi-Table Processing Loop
    ProcessAllTables --> TableLoop{{ğŸ”„ For Each Table Configuration}}
    ProcessRemaining --> TableLoop
    
    TableLoop --> GetTableConfig[âš™ï¸ Get Table Config<br/>â€¢ table_name<br/>â€¢ primary_key<br/>â€¢ chunk_size<br/>â€¢ columns<br/>â€¢ where_clause<br/>â€¢ max_threads]
    
    %% Per-Table Processing
    GetTableConfig --> GetRowCounts[ğŸ“Š Get Row Counts<br/>Source & Target]
    GetRowCounts --> GenerateBatches[ğŸ“¦ Generate Batches<br/>Based on chunk_size]
    
    GenerateBatches --> BatchLoop{{ğŸ”„ Process Batches in Parallel}}
    
    %% Batch Processing Details
    BatchLoop --> FetchSource[ğŸ“¥ Fetch Source Batch<br/>SELECT with ROWNUM pagination]
    BatchLoop --> FetchTarget[ğŸ“¥ Fetch Target Batch<br/>SELECT with ROWNUM pagination]
    
    FetchSource --> BuildSourceQuery[ğŸ”§ Build Source Query<br/>â€¢ Apply WHERE clause<br/>â€¢ Select specified columns<br/>â€¢ Order by PRIMARY_KEY<br/>â€¢ ROWNUM pagination]
    FetchTarget --> BuildTargetQuery[ğŸ”§ Build Target Query<br/>â€¢ Apply WHERE clause<br/>â€¢ Select specified columns<br/>â€¢ Order by PRIMARY_KEY<br/>â€¢ ROWNUM pagination]
    
    BuildSourceQuery --> ExecuteSource[âš¡ Execute Source Query]
    BuildTargetQuery --> ExecuteTarget[âš¡ Execute Target Query]
    
    ExecuteSource --> HashSource[ğŸ” Generate Source Hashes<br/>MD5 of row data]
    ExecuteTarget --> HashTarget[ğŸ” Generate Target Hashes<br/>MD5 of row data]
    
    %% Comparison Logic
    HashSource --> CompareHashes{âš–ï¸ Compare Row Hashes}
    HashTarget --> CompareHashes
    
    CompareHashes --> FindMissing[ğŸ” Find Missing Records<br/>â€¢ Missing in Target<br/>â€¢ Missing in Source]
    CompareHashes --> FindMismatches[ğŸ” Find Hash Mismatches<br/>Same PK, Different Hash]
    
    FindMissing --> GenSQL1[ğŸ“ Generate SQL<br/>â€¢ INSERT for missing in target<br/>â€¢ DELETE for missing in source]
    FindMismatches --> GenSQL2[ğŸ“ Generate SQL<br/>â€¢ UPDATE for mismatched rows]
    
    GenSQL1 --> SaveCheckpoint[ğŸ’¾ Save Batch Checkpoint<br/>to Metadata Table]
    GenSQL2 --> SaveCheckpoint
    
    SaveCheckpoint --> UpdateProgress[ğŸ“ˆ Update Progress Bar<br/>Per-table Statistics]
    UpdateProgress --> NextBatch{ğŸ”„ More Batches?}
    
    NextBatch -->|Yes| BatchLoop
    NextBatch -->|No| TableComplete[âœ… Table Processing Complete]
    
    %% Table Completion
    TableComplete --> UpdateTableStats[ğŸ“Š Update Table Statistics<br/>â€¢ Row counts<br/>â€¢ Mismatch counts<br/>â€¢ Processing time]
    UpdateTableStats --> NextTable{ğŸ”„ More Tables?}
    
    NextTable -->|Yes| TableLoop
    NextTable -->|No| AllTablesComplete[âœ… All Tables Complete]
    
    %% Post-Processing
    AllTablesComplete --> GenSQLFiles[ğŸ“„ Generate SQL Files<br/>â€¢ source_sync_statements.sql<br/>â€¢ target_sync_statements.sql]
    GenSQLFiles --> PKVerification{ğŸ” PK Verification Enabled?}
    
    PKVerification -->|Yes| VerifyPK[âœ… Verify Primary Keys<br/>Check for constraint violations]
    PKVerification -->|No| GenReports
    VerifyPK --> GenVerifiedSQL[ğŸ“„ Generate Verified SQL<br/>target_sync_statements_verified.sql]
    GenVerifiedSQL --> GenReports[ğŸ“Š Generate Reports]
    
    %% Reporting and Cleanup
    GenReports --> SummaryReport[ğŸ“‹ Generate Summary Report<br/>â€¢ Executive summary<br/>â€¢ Per-table statistics<br/>â€¢ Performance metrics]
    GenReports --> AuditLog[ğŸ“ Write Audit Logs<br/>â€¢ Detailed operation log<br/>â€¢ Compliance trail]
    GenReports --> HTMLReport[ğŸŒ Generate HTML Report<br/>â€¢ Visual dashboard<br/>â€¢ Detailed breakdown]
    
    SummaryReport --> Cleanup[ğŸ§¹ Cleanup Resources<br/>â€¢ Close DB connections<br/>â€¢ Clean temp files]
    AuditLog --> Cleanup
    HTMLReport --> Cleanup
    
    Cleanup --> Success([ğŸ‰ DB-Sentinel Complete<br/>All tables compared successfully])
    
    %% Error Handling
    ConfigError --> ErrorExit([âŒ Exit with Error])
    TableError --> ErrorExit
    
    %% Parallel Processing Visualization
    subgraph ThreadPool ["ğŸ”€ Multi-Threading (Per Table)"]
        T1[Thread 1<br/>Batch 0, 4, 8...]
        T2[Thread 2<br/>Batch 1, 5, 9...]
        T3[Thread 3<br/>Batch 2, 6, 10...]
        T4[Thread 4<br/>Batch 3, 7, 11...]
    end
    
    BatchLoop -.-> ThreadPool
    
    %% Database Schema
    subgraph SourceDB ["ğŸ—„ï¸ Source Database"]
        ST1[(Table 1)]
        ST2[(Table 2)]
        ST3[(Table N...)]
    end
    
    subgraph TargetDB ["ğŸ—„ï¸ Target Database"]
        TT1[(Table 1)]
        TT2[(Table 2)]
        TT3[(Table N...)]
    end
    
    ExecuteSource -.-> SourceDB
    ExecuteTarget -.-> TargetDB
    
    %% Metadata Storage
    subgraph MetadataDB ["ğŸ“Š Metadata & Checkpoints"]
        CheckpointTable[(TABLE_COMPARISON_METADATA)]
        AuditTable[(TABLE_COMPARISON_AUDIT)]
    end
    
    SaveCheckpoint -.-> MetadataDB
    LoadCheckpoint -.-> MetadataDB
    
    %% Output Files
    subgraph OutputFiles ["ğŸ“ Generated Output"]
        SQLSource[source_sync_statements.sql]
        SQLTarget[target_sync_statements.sql]
        SQLVerified[target_sync_statements_verified.sql]
        ReportTXT[summary_report.txt]
        ReportHTML[detailed_report.html]
        LogFiles[audit.log]
    end
    
    GenSQLFiles -.-> OutputFiles
    GenVerifiedSQL -.-> OutputFiles
    GenReports -.-> OutputFiles
    
    %% Configuration Details
    subgraph ConfigDetails ["âš™ï¸ Multi-Table Configuration"]
        CT1["Table 1:<br/>â€¢ primary_key: [ID]<br/>â€¢ chunk_size: 10000<br/>â€¢ columns: ALL<br/>â€¢ where_clause: null"]
        CT2["Table 2:<br/>â€¢ primary_key: [ORDER_ID, LINE_ID]<br/>â€¢ chunk_size: 5000<br/>â€¢ columns: [ID, QTY, PRICE]<br/>â€¢ where_clause: STATUS='ACTIVE'"]
        CT3["Table N:<br/>â€¢ primary_key: [LOG_ID]<br/>â€¢ chunk_size: 2000<br/>â€¢ columns: [ID, USER, ACTION]<br/>â€¢ where_clause: DATE >= '2024-01-01'"]
    end
    
    GetTableConfig -.-> ConfigDetails
    
    %% Styling
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef database fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef parallel fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    
    class Start,Success,ErrorExit startEnd
    class LoadConfig,ParseTables,InitDB,GetRowCounts,GenerateBatches,HashSource,HashTarget,GenSQLFiles,GenReports,Cleanup process
    class ValidateConfig,CheckRestart,NextBatch,NextTable,PKVerification decision
    class ConnSource,ConnTarget,SourceDB,TargetDB,MetadataDB database
    class ConfigError,TableError error
    class ThreadPool,T1,T2,T3,T4 parallel